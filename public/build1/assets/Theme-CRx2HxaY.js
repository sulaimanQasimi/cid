function g(s){return Number(s)!==s}function y(s){return{}.toString.call(s)}function N(s,e="Assertion failed"){if(!s)throw new Error(e)}function E(s){if(s!=null&&!a(s)){let e=Number(s);return g(e)&&S(s)&&s!=""&&s.match(/[0-9]+/)?E(s.replace(/[^0-9.\-]+/g,"")):e}return s}function z(s){if(j(s))return new Date(s);if(a(s))return new Date(s);{let e=Number(s);return a(e)?new Date(e):new Date(s)}}function F(s){if(g(s))return"NaN";if(s===1/0)return"Infinity";if(s===-1/0)return"-Infinity";if(s===0&&1/s===-1/0)return"-0";let e=s<0;s=Math.abs(s);let t=/^([0-9]+)(?:\.([0-9]+))?(?:e[\+\-]([0-9]+))?$/.exec(""+s),i=t[1],r=t[2]||"",n;if(t[3]===void 0)n=r===""?i:i+"."+r;else{let o=+t[3];if(s<1){let u=o-1;n="0."+_("0",u)+i+r}else{let u=o-r.length;u===0?n=i+r:u<0?n=i+r.slice(0,u)+"."+r.slice(u):n=i+r+_("0",u)}}return e?"-"+n:n}function _(s,e){return new Array(e+1).join(s)}function j(s){return y(s)==="[object Date]"}function S(s){return typeof s=="string"}function a(s){return typeof s=="number"&&Number(s)==s}function A(s){return typeof s=="object"&&s!==null}function $(s){return Array.isArray(s)}const B="__§§§__",H="__§§§§__",me=Object.freeze(Object.defineProperty({__proto__:null,PLACEHOLDER:B,PLACEHOLDER2:H,assert:N,getType:y,isArray:$,isDate:j,isNaN:g,isNumber:a,isObject:A,isString:S,numberToString:F,repeat:_,toDate:z,toNumber:E},Symbol.toStringTag,{value:"Module"}));function v(s,e){const t=s.length;for(let i=0;i<t;++i)if(s[i]===e)return i;return-1}function k(s,e){const t=s.length;for(let i=0;i<t;++i)if(e(s[i]))return!0;return!1}function K(s,e){const t=s.length,i=new Array(t);for(let r=0;r<t;++r)i[r]=e(s[r],r);return i}function l(s,e){const t=s.length;for(let i=0;i<t;++i)e(s[i],i)}function V(s,e){let t=s.length;for(;t>0;)--t,e(s[t],t)}function Y(s,e){const t=s.length;for(let i=0;i<t&&e(s[i],i);++i);}function q(s,e){const t=s.length;for(let i=e;i<t;++i)s[i-e]=s[i];s.length=t-e}function G(s){const e=s.length;return e?s[e-1]:void 0}function J(s){return s[0]}function C(s,e,t){t=Math.max(0,Math.min(t,s.length)),s.splice(t,0,e)}function Q(s,e,t){w(s,e),C(s,e,t)}function U(s,e){const t=e.length;for(let i=0;i<t;++i)s.push(e[i])}function w(s,e){let t=!1,i=0;for(;;){if(i=s.indexOf(e,i),i===-1)return t;t=!0,s.splice(i,1)}}function f(s,e){let t=s.indexOf(e);return t!==-1?(s.splice(t,1),!0):!1}function W(s,e,t){let i=v(s,e);i!==-1&&T(s,i),t==null?s.push(e):L(s,t,e)}function X(s,e,t){a(t)?t===0?s.unshift(e):s.splice(t,0,e):s.push(e)}function Z(s,e){s.indexOf(e)===-1&&s.push(e)}function ee(s,e,t){let i=s.indexOf(e);i!==-1&&s.splice(i,1),a(t)?s.splice(t,0,e):s.push(e)}function te(s){return Array.isArray(s)?s:[s]}function se(s,e){return v(s,e)!==-1}function ie(s){const e=s.length,t=new Array(e);for(let i=0;i<e;++i)t[i]=s[i];return t}function re(s,e,t=s.length){const i=new Array(t-e);for(let r=e;r<t;++r)i[r-e]=s[r];return i}function L(s,e,t){s.splice(e,0,t)}function T(s,e){s.splice(e,1)}function m(s,e){const t=s.length;for(let i=0;i<t;++i)if(e(s[i],i))return i;return-1}function x(s,e){let t=s.length;for(;t>0;)if(--t,e(s[t],t))return t;return-1}function ne(s,e){const t=m(s,e);if(t!==-1)return s[t]}function oe(s,e){const t=x(s,e);if(t!==-1)return s[t]}function ue(s,e){const t=s.length;for(let i=0;i<t;++i){const r=e(s[i],i);if(r!==void 0)return r}}function le(s){let e=s.length,t,i;for(;e!==0;)i=Math.floor(Math.random()*e),e-=1,t=s[e],s[e]=s[i],s[i]=t}function I(s,e){let t=0,i=s.length,r=!1;for(;t<i;){const n=t+i>>1,o=e(s[n]);o<0?t=n+1:o===0?(r=!0,t=n+1):i=n}return{found:r,index:r?t-1:t}}function he(s,e){let t=0,i=s.length,r=!1;for(;t<i;){const n=t+i>>1,o=e(s[n]);o<0?t=n+1:(o===0&&(r=!0),i=n)}return{found:r,index:t}}function ae(s,e){let t=s.length;for(;t>0;)--t,e(s[t])||s.splice(t,1)}const Oe=Object.freeze(Object.defineProperty({__proto__:null,add:X,any:k,copy:ie,each:l,eachContinue:Y,eachReverse:V,find:ne,findIndex:m,findIndexReverse:x,findMap:ue,findReverse:oe,first:J,getFirstSortedIndex:he,getSortedIndex:I,has:se,indexOf:v,insert:C,insertIndex:L,keepIf:ae,last:G,map:K,move:W,pushAll:U,pushOne:Z,remove:w,removeFirst:f,removeIndex:T,replace:ee,setIndex:Q,shiftLeft:q,shuffle:le,slice:re,toArray:te},Symbol.toStringTag,{value:"Module"}));function p(s){return Object.keys(s)}function R(s,e){return p(s).sort(e)}function de(s){return Object.assign({},s)}function h(s,e){p(s).forEach(t=>{e(t,s[t])})}function ce(s,e){for(let t in s)if(M(s,t)&&!e(t,s[t]))break}function fe(s,e,t){l(R(s,t),i=>{e(i,s[i])})}function M(s,e){return{}.hasOwnProperty.call(s,e)}function pe(s,e){return h(s,(t,i)=>{i!=null&&e[t]==null&&(e[t]=i)}),e}const Pe=Object.freeze(Object.defineProperty({__proto__:null,copy:de,each:h,eachContinue:ce,eachOrdered:fe,hasKey:M,keys:p,keysOrdered:R,softCopyProperties:pe},Symbol.toStringTag,{value:"Module"}));class O{constructor(){Object.defineProperty(this,"_disposed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._disposed=!1}isDisposed(){return this._disposed}dispose(){this._disposed||(this._disposed=!0,this._dispose())}}class d{constructor(e){Object.defineProperty(this,"_disposed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_dispose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._disposed=!1,this._dispose=e}isDisposed(){return this._disposed}dispose(){this._disposed||(this._disposed=!0,this._dispose())}}class De extends O{constructor(){super(...arguments),Object.defineProperty(this,"_disposers",{enumerable:!0,configurable:!0,writable:!0,value:[]})}_dispose(){l(this._disposers,e=>{e.dispose()})}}class P extends O{constructor(e){super(),Object.defineProperty(this,"_disposers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._disposers=e}_dispose(){l(this._disposers,e=>{e.dispose()})}get disposers(){return this._disposers}}class ye extends O{constructor(){super(...arguments),Object.defineProperty(this,"_disposer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_value",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}_dispose(){this._disposer!=null&&(this._disposer.dispose(),this._disposer=void 0)}get(){return this._value}set(e,t){this._disposer!=null&&this._disposer.dispose(),this._disposer=t,this._value=e}reset(){this.set(void 0,void 0)}}class Ee extends d{constructor(){super(...arguments),Object.defineProperty(this,"_counter",{enumerable:!0,configurable:!0,writable:!0,value:0})}increment(){return++this._counter,new d(()=>{--this._counter,this._counter===0&&this.dispose()})}}class _e{constructor(){Object.defineProperty(this,"_listeners",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_killed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_disabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_iterating",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_enabled",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_disposed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._listeners=[],this._killed=[],this._disabled={},this._iterating=0,this._enabled=!0,this._disposed=!1}isDisposed(){return this._disposed}dispose(){if(!this._disposed){this._disposed=!0;const e=this._listeners;this._iterating=1,this._listeners=null,this._disabled=null;try{l(e,t=>{t.disposer.dispose()})}finally{this._killed=null,this._iterating=null}}}hasListeners(){return this._listeners.length!==0}hasListenersByType(e){return k(this._listeners,t=>(t.type===null||t.type===e)&&!t.killed)}enable(){this._enabled=!0}disable(){this._enabled=!1}enableType(e){delete this._disabled[e]}disableType(e,t=1/0){this._disabled[e]=t}_removeListener(e){if(this._iterating===0){const t=this._listeners.indexOf(e);if(t===-1)throw new Error("Invalid state: could not remove listener");this._listeners.splice(t,1)}else this._killed.push(e)}_removeExistingListener(e,t,i,r){if(this._disposed)throw new Error("EventDispatcher is disposed");this._eachListener(n=>{n.once===e&&n.type===t&&(i===void 0||n.callback===i)&&n.context===r&&n.disposer.dispose()})}isEnabled(e){if(this._disposed)throw new Error("EventDispatcher is disposed");return this._enabled&&this._listeners.length>0&&this.hasListenersByType(e)&&this._disabled[e]===void 0}removeType(e){if(this._disposed)throw new Error("EventDispatcher is disposed");this._eachListener(t=>{t.type===e&&t.disposer.dispose()})}has(e,t,i){return m(this._listeners,n=>n.once!==!0&&n.type===e&&(t===void 0||n.callback===t)&&n.context===i)!==-1}_shouldDispatch(e){if(this._disposed)throw new Error("EventDispatcher is disposed");const t=this._disabled[e];return a(t)?(t<=1?delete this._disabled[e]:--this._disabled[e],!1):this._enabled}_eachListener(e){++this._iterating;try{l(this._listeners,e)}finally{--this._iterating,this._iterating===0&&this._killed.length!==0&&(l(this._killed,t=>{this._removeListener(t)}),this._killed.length=0)}}dispatch(e,t){this._shouldDispatch(e)&&this._eachListener(i=>{!i.killed&&(i.type===null||i.type===e)&&i.dispatch(e,t)})}_on(e,t,i,r,n,o){if(this._disposed)throw new Error("EventDispatcher is disposed");this._removeExistingListener(e,t,i,r);const u={type:t,callback:i,context:r,shouldClone:n,dispatch:o,killed:!1,once:e,disposer:new d(()=>{u.killed=!0,this._removeListener(u)})};return this._listeners.push(u),u}onAll(e,t,i=!0){return this._on(!1,null,e,t,i,(r,n)=>e.call(t,n)).disposer}on(e,t,i,r=!0){return this._on(!1,e,t,i,r,(n,o)=>t.call(i,o)).disposer}once(e,t,i,r=!0){const n=this._on(!0,e,t,i,r,(o,u)=>{n.disposer.dispose(),t.call(i,u)});return n.disposer}off(e,t,i){this._removeExistingListener(!1,e,t,i)}copyFrom(e){if(this._disposed)throw new Error("EventDispatcher is disposed");if(e===this)throw new Error("Cannot copyFrom the same TargetedEventDispatcher");const t=[];return l(e._listeners,i=>{!i.killed&&i.shouldClone&&(i.type===null?t.push(this.onAll(i.callback,i.context)):i.once?t.push(this.once(i.type,i.callback,i.context)):t.push(this.on(i.type,i.callback,i.context)))}),new P(t)}}function c(s,e){return s===e?0:s<e?-1:1}function be(s,e,t){const i=s.length,r=e.length,n=Math.min(i,r);for(let o=0;o<n;++o){const u=t(s[o],e[o]);if(u!==0)return u}return c(i,r)}function b(s){h(s,(e,t)=>{A(t)&&typeof t.dispose=="function"&&(t.enableDispose=!0,t.dispose())})}class ge{constructor(e,t,i){Object.defineProperty(this,"_settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this._name=e,this._template=t,this._settings=i}_dispose(){b(this._settings)}get(e,t){const i=this._settings[e];return i!==void 0?i:t}set(e,t){this._settings[e]=t,this._template._stateChanged(this._name)}remove(e){delete this._settings[e],this._template._stateChanged(this._name)}setAll(e){p(e).forEach(t=>{this._settings[t]=e[t]}),this._template._stateChanged(this._name)}_apply(e,t){h(this._settings,(i,r)=>{!t[i]&&!e._userSettings[i]&&(t[i]=!0,e.setRaw(i,r))})}}class ve{constructor(e){Object.defineProperty(this,"_template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_states",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this._template=e}_dispose(){h(this._states,(e,t)=>{t._dispose()})}lookup(e){return this._states[e]}create(e,t){const i=this._states[e];if(i)return i.setAll(t),i;{const r=new ge(e,this._template,t);return this._states[e]=r,this._template._stateChanged(e),r}}remove(e){delete this._states[e],this._template._stateChanged(e)}_apply(e,t){h(this._states,(i,r)=>{let n=t.states[i];n==null&&(n=t.states[i]={});const o=e.states.create(i,{});r._apply(o,n)})}}class we{constructor(){Object.defineProperty(this,"_callbacks",{enumerable:!0,configurable:!0,writable:!0,value:{}})}add(e,t){let i=this._callbacks[e];return i===void 0&&(i=this._callbacks[e]=[]),i.push(t),new d(()=>{f(i,t),i.length===0&&delete this._callbacks[e]})}remove(e){this._callbacks[e]!==void 0&&delete this._callbacks[e]}_apply(e){const t=[];return h(this._callbacks,(i,r)=>{l(r,n=>{t.push(e.adapters.add(i,n))})}),new P(t)}}class D{constructor(e,t){if(Object.defineProperty(this,"_disposed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"_settings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_privateSettings",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"_settingEvents",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"_privateSettingEvents",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"_entities",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"states",{enumerable:!0,configurable:!0,writable:!0,value:new ve(this)}),Object.defineProperty(this,"adapters",{enumerable:!0,configurable:!0,writable:!0,value:new we}),Object.defineProperty(this,"events",{enumerable:!0,configurable:!0,writable:!0,value:new _e}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),!t)throw new Error("You cannot use `new Class()`, instead use `Class.new()`");this._settings=e}static new(e){return new D(e,!0)}_dispose(){b(this._settings),b(this._privateSettings)}isDisposed(){return this._disposed}dispose(){this._disposed||(this._disposed=!0,this._dispose())}_checkDisposed(){if(this._disposed)throw new Error("Template is disposed")}get entities(){return this._entities}get(e,t){this._checkDisposed();const i=this._settings[e];return i!==void 0?i:t}setRaw(e,t){this._checkDisposed(),this._settings[e]=t}set(e,t){this._checkDisposed(),this._settings[e]!==t&&(this.setRaw(e,t),this._entities.forEach(i=>{i._setTemplateProperty(this,e,t)}))}remove(e){this._checkDisposed(),e in this._settings&&(delete this._settings[e],this._entities.forEach(t=>{t._removeTemplateProperty(e)}))}removeAll(){this._checkDisposed(),h(this._settings,(e,t)=>{this.remove(e)})}getPrivate(e,t){this._checkDisposed();const i=this._privateSettings[e];return i!==void 0?i:t}setPrivateRaw(e,t){return this._checkDisposed(),this._privateSettings[e]=t,t}setPrivate(e,t){return this._checkDisposed(),this._privateSettings[e]!==t&&(this.setPrivateRaw(e,t),this._entities.forEach(i=>{i._setTemplatePrivateProperty(this,e,t)})),t}removePrivate(e){this._checkDisposed(),e in this._privateSettings&&(delete this._privateSettings[e],this._entities.forEach(t=>{t._removeTemplatePrivateProperty(e)}))}setAll(e){this._checkDisposed(),h(e,(t,i)=>{this.set(t,i)})}on(e,t){this._checkDisposed();let i=this._settingEvents[e];return i===void 0&&(i=this._settingEvents[e]=[]),i.push(t),new d(()=>{f(i,t),i.length===0&&delete this._settingEvents[e]})}onPrivate(e,t){this._checkDisposed();let i=this._privateSettingEvents[e];return i===void 0&&(i=this._privateSettingEvents[e]=[]),i.push(t),new d(()=>{f(i,t),i.length===0&&delete this._privateSettingEvents[e]})}_apply(e,t){this._checkDisposed();const i=[];return h(this._settingEvents,(r,n)=>{l(n,o=>{i.push(e.on(r,o))})}),h(this._privateSettingEvents,(r,n)=>{l(n,o=>{i.push(e.onPrivate(r,o))})}),this.states._apply(e,t),i.push(this.adapters._apply(e)),i.push(e.events.copyFrom(this.events)),new P(i)}_setObjectTemplate(e){this._checkDisposed(),this._entities.push(e)}_removeObjectTemplate(e){w(this._entities,e)}_stateChanged(e){this._checkDisposed(),this._entities.forEach(t=>{t._applyStateByKey(e)})}}class je{constructor(e,t){if(Object.defineProperty(this,"_root",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_rules",{enumerable:!0,configurable:!0,writable:!0,value:{}}),this._root=e,!t)throw new Error("You cannot use `new Class()`, instead use `Class.new()`")}static new(e){const t=new this(e,!0);return t.setupDefaultRules(),t}setupDefaultRules(){}_lookupRules(e){return this._rules[e]}ruleRaw(e,t=[]){let i=this._rules[e];i||(i=this._rules[e]=[]),t.sort(c);const{index:r,found:n}=I(i,o=>{const u=c(o.tags.length,t.length);return u===0?be(o.tags,t,c):u});if(n)return i[r].template;{const o=D.new({});return i.splice(r,0,{tags:t,template:o}),o}}rule(e,t=[]){return this.ruleRaw(e,t)}}export{De as A,oe as B,Ee as C,d as D,_e as E,ne as F,he as G,be as H,R as I,z as J,j as K,g as L,P as M,$ as N,Oe as O,B as P,Pe as Q,me as R,ye as S,je as T,pe as U,U as V,h as a,D as b,ae as c,S as d,l as e,A as f,de as g,H as h,a as i,ce as j,p as k,v as l,K as m,F as n,f as o,Y as p,Z as q,w as r,ie as s,E as t,O as u,W as v,c as w,L as x,T as y,V as z};
