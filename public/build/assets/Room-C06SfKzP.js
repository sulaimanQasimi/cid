import{r,a as x,j as s,L as le,S as de}from"./app-D74mREVM.js";import{B as u}from"./button-uDl4pIMx.js";import{B}from"./badge-DZrm4xRx.js";import{I as fe}from"./input-Ume2VGdw.js";import{A as H,b as W}from"./avatar-3s05pm0V.js";import{c as f}from"./createLucideIcon-Crymk4f-.js";import"./utils-BTlUEAsc.js";import"./index-iZ6kEidv.js";import"./index-CP1eoeio.js";/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",key:"1lielz"}]],ue=f("MessageSquare",he);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],xe=f("MicOff",me);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ge=[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],pe=f("Mic",ge);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=[["path",{d:"M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-3.33-2.67m-2.67-3.34a19.79 19.79 0 0 1-3.07-8.63A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91",key:"z86iuo"}],["line",{x1:"22",x2:"2",y1:"2",y2:"22",key:"11kh81"}]],Y=f("PhoneOff",ye);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=[["path",{d:"M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8",key:"1b2hhj"}],["polyline",{points:"16 6 12 2 8 6",key:"m901s6"}],["line",{x1:"12",x2:"12",y1:"2",y2:"15",key:"1p0rca"}]],we=f("Share",ve);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const je=[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],_e=f("VideoOff",je);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ne=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],be=f("Video",Ne);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Se=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],ke=f("WifiOff",Se);/**
 * @license lucide-react v0.475.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]],Ce=f("Wifi",Me),U={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"}]};function Je({auth:d,meeting:i,isOfflineEnabled:v}){const[Oe,E]=r.useState(!1),[g,p]=r.useState(!1),[w,q]=r.useState(null),[$,D]=r.useState(""),[j,y]=r.useState({}),[l,L]=r.useState(null),[m,T]=r.useState(!0),[_,Z]=r.useState(!0),[N,z]=r.useState(!1),[C,O]=r.useState([]),[b,V]=r.useState(""),[A,G]=r.useState([]),[Ie,K]=r.useState(navigator.onLine),I=r.useRef(null),S=r.useRef(null);route("meetings.index"),i.title,r.useEffect(()=>{const e=`peer_${d.user.id}_${Date.now()}`;return D(e),!navigator.onLine&&v?(p(!0),ee(e)):Q().then(()=>{X(e)}),window.addEventListener("online",k),window.addEventListener("offline",k),()=>{console.log("Cleaning up peer connection"),l&&l.getTracks().forEach(a=>{a.stop()}),window.removeEventListener("online",k),window.removeEventListener("offline",k)}},[]),r.useEffect(()=>{S.current&&(S.current.scrollTop=S.current.scrollHeight)},[C]);const k=()=>{const e=navigator.onLine;K(e),e&&g?ne():!e&&v&&p(!0)},Q=async()=>{try{const e=await navigator.mediaDevices.getUserMedia({video:!0,audio:!0});return L(e),I.current&&(I.current.srcObject=e),e}catch(e){console.error("Error accessing media devices:",e);try{const a=await navigator.mediaDevices.getUserMedia({video:!1,audio:!0});return L(a),T(!1),a}catch(a){return console.error("Error accessing audio devices:",a),alert("Could not access camera or microphone. Please check your permissions."),null}}},X=async e=>{try{const a=await x.post(route("webrtc.init-session",i.id),{peer_id:e});q(a.data.session_id),a.data.active_peers.forEach(t=>{se(t.peer_id,t.user)}),R(),E(!0)}catch(a){console.error("Failed to initialize session:",a),alert("Failed to join the meeting. Please try again.")}},ee=e=>{D(e),E(!0);const a=localStorage.getItem(`offline_chat_${i.id}`);if(a)try{const t=JSON.parse(a);G(t)}catch(t){console.error("Failed to parse offline messages:",t)}},se=(e,a)=>{const t=new RTCPeerConnection(U);l&&l.getTracks().forEach(n=>{t.addTrack(n,l)});const o=t.createDataChannel("messages",{negotiated:!0,id:0});return o.onopen=()=>{console.log(`Data channel with ${e} opened`)},o.onmessage=n=>{try{const c=JSON.parse(n.data);c.type==="chat"&&oe(c.message,c.user,!0)}catch(c){console.error("Error parsing data channel message:",c)}},t.onicecandidate=n=>{n.candidate&&M(e,"candidate",n.candidate)},t.ontrack=n=>{y(c=>({...c,[e]:{...c[e],stream:n.streams[0]}}))},y(n=>({...n,[e]:{id:e,user:a,connection:t,stream:null,videoEl:null,dataChannel:o}})),te(t,e),t},te=async(e,a)=>{try{const t=await e.createOffer();await e.setLocalDescription(t),M(a,"offer",t)}catch(t){console.error("Error creating offer:",t)}},ae=async e=>{const{sender_peer_id:a,type:t,payload:o}=e;let n=j[a];if(!n){const c=new RTCPeerConnection(U);l&&l.getTracks().forEach(h=>{c.addTrack(h,l)}),c.onicecandidate=h=>{h.candidate&&M(a,"candidate",h.candidate)},c.ontrack=h=>{y(P=>({...P,[a]:{...P[a],stream:h.streams[0]}}))},n={id:a,user:{id:0,name:"Unknown",email:""},connection:c,stream:null,videoEl:null,dataChannel:null},y(h=>({...h,[a]:n}))}if(t==="offer"){await n.connection.setRemoteDescription(new RTCSessionDescription(o));const c=await n.connection.createAnswer();await n.connection.setLocalDescription(c),M(a,"answer",c)}else t==="answer"?await n.connection.setRemoteDescription(new RTCSessionDescription(o)):t==="candidate"&&await n.connection.addIceCandidate(new RTCIceCandidate(o))},M=(e,a,t)=>{if(g){const o={sender_peer_id:$,receiver_peer_id:e,meeting_id:i.id,type:a,payload:t,timestamp:new Date().toISOString(),is_offline:!0};localStorage.setItem(`offline_signals_${i.id}`,JSON.stringify([...JSON.parse(localStorage.getItem(`offline_signals_${i.id}`)||"[]"),o]));return}x.post(route("webrtc.signal"),{sender_peer_id:$,receiver_peer_id:e,meeting_id:i.id,type:a,payload:t,is_offline:!1}).catch(o=>{console.error("Error sending signal:",o),!navigator.onLine&&v&&p(!0)})},ne=async()=>{if(!w)return;const e=JSON.parse(localStorage.getItem(`offline_signals_${i.id}`)||"[]"),a=JSON.parse(localStorage.getItem(`offline_chat_${i.id}`)||"[]");try{const t=await x.post(route("webrtc.sync-offline",w),{offline_data:{signals:e},messages:a});localStorage.removeItem(`offline_signals_${i.id}`),localStorage.removeItem(`offline_chat_${i.id}`),t.data.pending_signals&&t.data.pending_signals.forEach(o=>{ae(o)}),R(),p(!1)}catch(t){console.error("Failed to sync offline data:",t)}},R=async()=>{try{const e=await x.get(route("webrtc.get-messages",i.id));O(e.data.messages)}catch(e){console.error("Failed to load chat messages:",e)}},ie=async()=>{if(!b.trim())return;const e=b.trim();V("");const a={id:Date.now(),user_id:d.user.id,meeting_id:i.id,message:e,is_offline:g,created_at:new Date().toISOString(),user:d.user};if(O(t=>[...t,a]),g){const t={content:e,timestamp:new Date().toISOString(),user:d.user},o=JSON.parse(localStorage.getItem(`offline_chat_${i.id}`)||"[]");o.push(t),localStorage.setItem(`offline_chat_${i.id}`,JSON.stringify(o)),Object.values(j).forEach(n=>{n.dataChannel&&n.dataChannel.readyState==="open"&&n.dataChannel.send(JSON.stringify({type:"chat",message:e,user:d.user}))});return}try{await x.post(route("webrtc.send-message",i.id),{message:e,is_offline:!1})}catch(t){if(console.error("Failed to send message:",t),!navigator.onLine&&v){p(!0);const o={content:e,timestamp:new Date().toISOString(),user:d.user},n=JSON.parse(localStorage.getItem(`offline_chat_${i.id}`)||"[]");n.push(o),localStorage.setItem(`offline_chat_${i.id}`,JSON.stringify(n))}}},oe=(e,a,t)=>{const o={id:Date.now(),user_id:a.id,meeting_id:i.id,message:e,is_offline:t,created_at:new Date().toISOString(),user:a};O(n=>[...n,o])},re=()=>{l&&(l.getVideoTracks().forEach(e=>{e.enabled=!m}),T(!m))},ce=()=>{l&&(l.getAudioTracks().forEach(e=>{e.enabled=!_}),Z(!_))},J=async()=>{if(w)try{await x.post(route("webrtc.end-session",w))}catch(e){console.error("Error ending session:",e)}l&&l.getTracks().forEach(e=>e.stop()),Object.values(j).forEach(e=>{e.connection&&e.connection.close()}),de.post(route("meetings.leave",i.id))},F=e=>new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});return s.jsxs("div",{className:"h-screen flex flex-col bg-gray-100",children:[s.jsx(le,{title:`Meeting: ${i.title}`}),s.jsx("div",{className:"bg-white border-b p-4",children:s.jsxs("div",{className:"max-w-7xl mx-auto flex justify-between items-center",children:[s.jsxs("div",{children:[s.jsx("h1",{className:"text-xl font-semibold",children:i.title}),s.jsxs("div",{className:"flex items-center text-sm text-gray-500",children:[s.jsxs("span",{className:"mr-2",children:["Meeting Code: ",i.meeting_code]}),g?s.jsxs(B,{variant:"outline",className:"bg-orange-100 text-orange-800 border-orange-200",children:[s.jsx(ke,{className:"h-3 w-3 mr-1"}),"Offline Mode"]}):s.jsxs(B,{variant:"outline",className:"bg-green-100 text-green-800 border-green-200",children:[s.jsx(Ce,{className:"h-3 w-3 mr-1"}),"Connected"]})]})]}),s.jsxs(u,{variant:"destructive",size:"sm",onClick:J,children:[s.jsx(Y,{className:"h-4 w-4 mr-1"}),"Leave Meeting"]})]})}),s.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[s.jsx("div",{className:`flex-1 p-4 ${N?"hidden md:block md:w-2/3":"w-full"}`,children:s.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4 h-full",children:[s.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-gray-900 min-h-[200px] flex items-center justify-center",children:[s.jsx("video",{ref:I,autoPlay:!0,muted:!0,playsInline:!0,className:`w-full h-full object-cover ${!m&&"hidden"}`}),!m&&s.jsxs("div",{className:"flex flex-col items-center text-white",children:[s.jsx(H,{className:"h-20 w-20 mb-2",children:s.jsx(W,{children:d.user.name.charAt(0)})}),s.jsxs("span",{children:[d.user.name," (You)"]})]}),s.jsxs("div",{className:"absolute bottom-2 left-2 text-white text-sm bg-black bg-opacity-50 px-2 py-1 rounded",children:[d.user.name," (You)"]})]}),Object.values(j).map(e=>{var a;return s.jsxs("div",{className:"relative rounded-lg overflow-hidden bg-gray-900 min-h-[200px] flex items-center justify-center",children:[e.stream?s.jsx("video",{ref:t=>{t&&e.stream&&!e.videoEl&&(t.srcObject=e.stream,y(o=>({...o,[e.id]:{...o[e.id],videoEl:t}})))},autoPlay:!0,playsInline:!0,className:"w-full h-full object-cover"}):s.jsxs("div",{className:"flex flex-col items-center text-white",children:[s.jsx(H,{className:"h-20 w-20 mb-2",children:s.jsx(W,{children:((a=e.user.name)==null?void 0:a.charAt(0))||"?"})}),s.jsx("span",{children:e.user.name||"Participant"})]}),s.jsx("div",{className:"absolute bottom-2 left-2 text-white text-sm bg-black bg-opacity-50 px-2 py-1 rounded",children:e.user.name||"Participant"})]},e.id)})]})}),N&&s.jsxs("div",{className:"w-full md:w-1/3 flex flex-col bg-white border-l",children:[s.jsxs("div",{className:"p-4 border-b flex justify-between items-center",children:[s.jsx("h2",{className:"font-semibold",children:"Meeting Chat"}),s.jsx(u,{variant:"ghost",size:"sm",onClick:()=>z(!1),className:"md:hidden",children:"Close"})]}),s.jsxs("div",{ref:S,className:"flex-1 overflow-y-auto p-4 space-y-4",children:[C.map(e=>s.jsx("div",{className:`flex ${e.user_id===d.user.id?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`max-w-[80%] rounded-lg px-4 py-2 ${e.user_id===d.user.id?"bg-blue-500 text-white":"bg-gray-200 text-gray-800"} ${e.is_offline?"italic opacity-80":""}`,children:[s.jsxs("div",{className:"font-semibold text-xs mb-1",children:[e.user_id===d.user.id?"You":e.user.name,e.is_offline&&" (sent offline)"]}),s.jsx("div",{children:e.message}),s.jsx("div",{className:"text-xs text-right mt-1 opacity-70",children:F(e.created_at)})]})},e.id)),A.map((e,a)=>s.jsx("div",{className:"flex justify-end",children:s.jsxs("div",{className:"max-w-[80%] rounded-lg px-4 py-2 bg-blue-500 text-white italic opacity-80",children:[s.jsx("div",{className:"font-semibold text-xs mb-1",children:"You (offline)"}),s.jsx("div",{children:e.content}),s.jsx("div",{className:"text-xs text-right mt-1 opacity-70",children:F(e.timestamp)})]})},`offline-${a}`)),C.length===0&&A.length===0&&s.jsx("div",{className:"text-center text-gray-500 py-8",children:"No messages yet. Start the conversation!"})]}),s.jsx("div",{className:"p-4 border-t",children:s.jsxs("form",{onSubmit:e=>{e.preventDefault(),ie()},className:"flex items-center space-x-2",children:[s.jsx(fe,{value:b,onChange:e=>V(e.target.value),placeholder:"Type a message...",className:"flex-1"}),s.jsx(u,{type:"submit",disabled:!b.trim(),children:"Send"})]})})]})]}),s.jsx("div",{className:"bg-white border-t p-4",children:s.jsxs("div",{className:"max-w-7xl mx-auto flex justify-center space-x-4",children:[s.jsx(u,{variant:_?"outline":"destructive",onClick:ce,className:"rounded-full w-12 h-12 p-0",children:_?s.jsx(pe,{className:"h-5 w-5"}):s.jsx(xe,{className:"h-5 w-5"})}),s.jsx(u,{variant:m?"outline":"destructive",onClick:re,className:"rounded-full w-12 h-12 p-0",children:m?s.jsx(be,{className:"h-5 w-5"}):s.jsx(_e,{className:"h-5 w-5"})}),s.jsx(u,{variant:N?"default":"outline",onClick:()=>z(!N),className:"rounded-full w-12 h-12 p-0",children:s.jsx(ue,{className:"h-5 w-5"})}),s.jsx(u,{variant:"outline",className:"rounded-full w-12 h-12 p-0",onClick:()=>{navigator.clipboard.writeText(window.location.href),alert("Meeting link copied to clipboard")},children:s.jsx(we,{className:"h-5 w-5"})}),s.jsx(u,{variant:"destructive",onClick:J,className:"rounded-full w-12 h-12 p-0",children:s.jsx(Y,{className:"h-5 w-5"})})]})})]})}export{Je as default};
